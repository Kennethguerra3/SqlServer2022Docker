name: Schedule SQL Server

on:
  schedule:
    # Horas en UTC. (Perú es UTC-5)
    # 03:00 AM PE -> 08:00 UTC (Start)
    # 04:00 AM PE -> 09:00 UTC (Stop)
    # 06:00 AM PE -> 11:00 UTC (Start)
    # 07:00 AM PE -> 12:00 UTC (Stop)
    # 11:20 PM PE -> 04:20 UTC (Next Day) (Start)
    # 12:20 AM PE -> 05:20 UTC (Stop)
    
    # Cron format: "min hour * * *"
    - cron: '0 8 * * *'  # Start 03:00 AM PE
    - cron: '0 9 * * *'  # Stop 04:00 AM PE
    - cron: '0 11 * * *' # Start 06:00 AM PE
    - cron: '0 12 * * *' # Stop 07:00 AM PE
    - cron: '20 4 * * *' # Start 11:20 PM PE (04:20 UTC)
    - cron: '20 5 * * *' # Stop 12:20 AM PE (05:20 UTC) - Assumed 1 hour duration

  workflow_dispatch:
    inputs:
      manual_action:
        description: 'Acción manual (Start/Stop)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - Start
          - Stop

jobs:
  manage-sql-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Determine Action
        id: action
        shell: pwsh
        run: |
          # 1. Prioridad: Acción manual desde la UI de GitHub
          $ManualAction = "${{ github.event.inputs.manual_action }}"
          
          if ($ManualAction -ne "") {
             $Action = $ManualAction
             Write-Host "Usando acción manual: $Action"
          } else {
             # 2. Lógica por horario (UTC)
             $Time = (Get-Date).ToUniversalTime()
             $Hour = $Time.Hour
             $Min = $Time.Minute
             
             # Ventanas de encendido (Start)
             # 08:00 (3am PE), 11:00 (6am PE), 04:20 (11:20pm PE)
             if (($Hour -eq 8) -or ($Hour -eq 11) -or ($Hour -eq 4)) {
                $Action = "Start"
             } else {
                $Action = "Stop"
             }
             Write-Host "Hora UTC detectada: ${Hour}:${Min}. Decision: $Action"
          }
          
          "ACTION=$Action" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Run Control Script
        shell: pwsh
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          ./scripts/railway_control.ps1 -Action $env:ACTION
